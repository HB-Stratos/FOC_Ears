//unuseable pins:
// 35-37 PSRAM
// 34-39 input-only
// 28-42 Octal PSRAM
// 0 strapping pin with pullup

#include "Arduino.h"
#include "SPI.h"
#include "SimpleFOC.h"
#include "SimpleFOCDrivers.h"
#include "encoders/MT6701/MagneticSensorMT6701SSI.h"
#include <encoders/calibrated/CalibratedSensor.h>

static SPISettings myMT6701SPISettings(4000000, MT6701_BITORDER, SPI_MODE2);
MagneticSensorMT6701SSI sensor = MagneticSensorMT6701SSI(47, myMT6701SPISettings);

// float calibrationLut[200] = {
// -0.021071, -0.021071, -0.021071, -0.021576, -0.021576, -0.021576, -0.021576, -0.021576, -0.021576, -0.021926, -0.021926, -0.021926, -0.021926, -0.021926, -0.021088, -0.021088, 
// -0.021088, -0.021088, -0.021088, -0.021088, -0.014881, -0.014881, -0.014881, -0.014881, -0.014881, -0.014881, -0.009479, -0.009479, -0.009479, -0.009479, -0.009479, -0.009479, 
// -0.004768, -0.004768, -0.004768, -0.004768, -0.004768, 0.003664, 0.003664, 0.003664, 0.003664, 0.003664, 0.003664, 0.008061, 0.008061, 0.008061, 0.008061, 0.008061, 0.008061, 0.008592, 0.008592, 0.008592, 0.008592, 0.008592, 0.008710, 0.008710, 0.008710, 0.008710, 0.008710, 0.008710, 0.011006, 0.011006, 0.011006, 0.011006, 0.011006, 0.011006, 0.010311, 0.010311, 0.010311, 0.010311, 0.010311, 0.010311, 0.014294, 0.014294, 0.014294, 0.014294, 0.014294, 0.014978, 0.014978, 0.014978, 0.014978, 0.014978, 0.014978, 0.013631, 0.013631, 0.013631, 0.013631, 0.013631, 0.013631, 0.012475, 0.012475, 0.012475, 0.012475, 0.012475, 0.009401, 0.009401, 0.009401, 0.009401, 0.009401, 0.009401, 0.006366, 0.006366, 0.006366, 0.006366, 0.006366, 0.006366, 0.004673, 0.004673, 0.004673, 0.004673, 0.004673, 0.004673, 0.003325, 0.003325, 0.003325, 0.003325, 0.003325, 0.004432, 0.004432, 0.004432, 0.004432, 0.004432, 0.004432, 0.006919, 0.006919, 0.006919, 0.006919, 0.006919, 0.006919, 0.007949, 0.007949, 0.007949, 0.007949, 0.007949, 0.009516, 0.009516, 0.009516, 0.009516, 0.009516, 0.009516, 0.008283, 0.008283, 0.008283, 0.008283, 0.008283, 0.008283, 0.004711, 0.004711, 0.004711, 0.004711, 0.004711, 0.004711, 0.002826, 0.002826, 0.002826, 0.002826, 0.002826, -0.000401, -0.000401, -0.000401, -0.000401, -0.000401, -0.000401, -0.003973, -0.003973, -0.003973, -0.003973, -0.003973, -0.003973, -0.004630, -0.004630, -0.004630, -0.004630, -0.004630, -0.007512, -0.007512, -0.007512, -0.007512, -0.007512, -0.007512, -0.012426, -0.012426, -0.012426, -0.012426, -0.012426, -0.012426, -0.013506, -0.013506, -0.013506, -0.013506, -0.013506, -0.013506, -0.016886, -0.016886, -0.016886, -0.016886, -0.016886, -0.021071, -0.021071, -0.021071};
// float zero_electric_angle = 4.119193;
// Direction sensor_direction = Direction::CW;

// float calibrationLut[200] = {
// -4.461547, -4.966309, -4.966309, -4.966309, -4.966309, -4.966309, -4.966309, -5.397632, -5.397632, -5.397632, -5.397632, -5.397632, -5.751105, -5.751105, -5.751105, -5.751105, 
// -5.751105, -5.751105, -4.536366, -4.536366, -4.536366, -4.536366, -4.536366, -4.536366, -2.792597, -2.792597, -2.792597, -2.792597, -2.792597, 0.973354, 0.973354, 0.973354, 0.973354, 0.973354, 0.973354, 3.244369, 3.244369, 3.244369, 3.244369, 3.244369, 3.244369, 5.516803, 5.516803, 5.516803, 5.516803, 5.516803, 5.516803, 5.274391, 5.274391, 5.274391, 5.274391, 5.274391, 5.028680, 5.028680, 5.028680, 5.028680, 5.028680, 5.028680, 4.769010, 4.769010, 4.769010, 4.769010, 4.769010, 4.769010, 4.481613, 4.481613, 4.481613, 4.481613, 4.481613, 4.147813, 4.147813, 4.147813, 4.147813, 4.147813, 4.147813, 3.743642, 3.743642, 3.743642, 3.743642, 3.743642, 3.743642, 3.236617, 3.236617, 3.236617, 3.236617, 3.236617, 3.236617, 2.670112, 2.670112, 2.670112, 2.670112, 2.670112, 2.093560, 2.093560, 2.093560, 2.093560, 2.093560, 2.093560, 1.541551, 1.541551, 1.541551, 1.541551, 1.541551, 1.541551, 1.050825, 1.050825, 1.050825, 1.050825, 1.050825, 0.664832, 0.664832, 0.664832, 0.664832, 0.664832, 0.664832, 0.346870, 0.346870, 0.346870, 0.346870, 0.346870, 0.346870, 0.064152, 0.064152, 0.064152, 0.064152, 0.064152, 0.064152, -0.192335, -0.192335, -0.192335, -0.192335, -0.192335, -0.438199, -0.438199, -0.438199, -0.438199, -0.438199, -0.438199, -0.683143, -0.683143, -0.683143, -0.683143, -0.683143, -0.683143, -0.923676, -0.923676, -0.923676, -0.923676, -0.923676, -1.167048, -1.167048, -1.167048, -1.167048, -1.167048, -1.167048, -1.424341, -1.424341, -1.424341, -1.424341, -1.424341, -1.424341, -1.695247, -1.695247, -1.695247, -1.695247, -1.695247, -1.695247, -1.996411, -1.996411, -1.996411, -1.996411, -1.996411, -2.367333, -2.367333, -2.367333, -2.367333, -2.367333, -2.367333, -2.816987, -2.816987, -2.816987, -2.816987, -2.816987, -2.816987, -3.336361, -3.336361, -3.336361, -3.336361, -3.336361, -3.901562, -3.901562, -3.901562, -3.901562, -3.901562, -3.901562, -4.461547, -4.461547, -4.461547, -4.461547, -4.461547};
// float zero_electric_angle = 2.888732;
// Direction sensor_direction = Direction::CW;

// float calibrationLut[500] = {
// -5.008715, -5.008715, -5.008715, -5.008715, -5.008715, -5.008715, -5.248366, -5.248366, -5.248366, -5.248366, -5.248366, -5.248366, -5.248366, -5.248366, -5.248366, -5.248366, 
// -5.248366, -5.248366, -5.248366, -5.248366, -3.986649, -3.986649, -3.986649, -3.986649, -3.986649, -3.986649, -3.986649, -3.986649, -3.986649, -3.986649, -3.986649, -3.986649, 
// -3.986649, -3.986649, -2.233122, -2.233122, -2.233122, -2.233122, -2.233122, -2.233122, -2.233122, -2.233122, -2.233122, -2.233122, -2.233122, -2.233122, -2.233122, -2.233122, 
// 1.537452, 1.537452, 1.537452, 1.537452, 1.537452, 1.537452, 1.537452, 1.537452, 1.537452, 1.537452, 1.537452, 1.537452, 1.537452, 1.537452, 1.537452, 3.759840, 3.759840, 3.759840, 3.759840, 3.759840, 3.759840, 3.759840, 3.759840, 3.759840, 3.759840, 3.759840, 3.759840, 3.759840, 3.759840, 5.940619, 5.940619, 5.940619, 5.940619, 5.940619, 5.940619, 5.940619, 5.940619, 5.940619, 5.940619, 5.940619, 5.940619, 5.940619, 5.940619, 5.530427, 5.530427, 5.530427, 5.530427, 5.530427, 5.530427, 5.530427, 5.530427, 5.530427, 5.530427, 5.530427, 5.530427, 5.530427, 5.530427, 5.530427, 5.022481, 5.022481, 5.022481, 5.022481, 5.022481, 5.022481, 5.022481, 5.022481, 5.022481, 5.022481, 5.022481, 5.022481, 5.022481, 5.022481, 4.458469, 4.458469, 4.458469, 4.458469, 4.458469, 4.458469, 4.458469, 4.458469, 4.458469, 4.458469, 4.458469, 4.458469, 4.458469, 4.458469, 3.881610, 3.881610, 
// 3.881610, 3.881610, 3.881610, 3.881610, 3.881610, 3.881610, 3.881610, 3.881610, 3.881610, 3.881610, 3.881610, 3.881610, 3.325307, 3.325307, 3.325307, 3.325307, 3.325307, 3.325307, 3.325307, 3.325307, 3.325307, 3.325307, 3.325307, 3.325307, 3.325307, 3.325307, 3.325307, 2.842788, 2.842788, 2.842788, 2.842788, 2.842788, 2.842788, 2.842788, 2.842788, 2.842788, 2.842788, 2.842788, 2.842788, 2.842788, 2.842788, 2.456219, 2.456219, 2.456219, 2.456219, 2.456219, 2.456219, 2.456219, 2.456219, 2.456219, 2.456219, 2.456219, 2.456219, 2.456219, 2.456219, 2.137107, 2.137107, 2.137107, 2.137107, 2.137107, 2.137107, 2.137107, 2.137107, 2.137107, 2.137107, 2.137107, 2.137107, 2.137107, 2.137107, 2.137107, 1.858415, 1.858415, 1.858415, 1.858415, 1.858415, 1.858415, 1.858415, 1.858415, 1.858415, 1.858415, 1.858415, 1.858415, 1.858415, 1.858415, 1.602465, 1.602465, 1.602465, 1.602465, 
// 1.602465, 1.602465, 1.602465, 1.602465, 1.602465, 1.602465, 1.602465, 1.602465, 1.602465, 1.602465, 1.355297, 1.355297, 1.355297, 1.355297, 1.355297, 1.355297, 1.355297, 1.355297, 1.355297, 1.355297, 1.355297, 1.355297, 1.355297, 1.355297, 1.112577, 1.112577, 1.112577, 1.112577, 1.112577, 1.112577, 1.112577, 1.112577, 1.112577, 1.112577, 1.112577, 1.112577, 1.112577, 1.112577, 1.112577, 0.871161, 0.871161, 0.871161, 0.871161, 0.871161, 0.871161, 0.871161, 0.871161, 0.871161, 0.871161, 0.871161, 0.871161, 0.871161, 0.871161, 0.626332, 0.626332, 0.626332, 0.626332, 0.626332, 0.626332, 0.626332, 0.626332, 0.626332, 0.626332, 0.626332, 0.626332, 0.626332, 0.626332, 0.371571, 0.371571, 0.371571, 0.371571, 0.371571, 0.371571, 0.371571, 0.371571, 0.371571, 0.371571, 0.371571, 0.371571, 0.371571, 0.371571, 0.371571, 0.099207, 0.099207, 0.099207, 0.099207, 0.099207, 0.099207, 
// 0.099207, 0.099207, 0.099207, 0.099207, 0.099207, 0.099207, 0.099207, 0.099207, -0.203568, -0.203568, -0.203568, -0.203568, -0.203568, -0.203568, -0.203568, -0.203568, -0.203568, -0.203568, -0.203568, -0.203568, -0.203568, -0.203568, -0.568124, -0.568124, -0.568124, -0.568124, -0.568124, -0.568124, -0.568124, -0.568124, -0.568124, -0.568124, -0.568124, -0.568124, -0.568124, -0.568124, -1.017280, -1.017280, -1.017280, -1.017280, -1.017280, -1.017280, -1.017280, -1.017280, -1.017280, -1.017280, -1.017280, -1.017280, -1.017280, -1.017280, -1.017280, -1.537496, -1.537496, -1.537496, -1.537496, -1.537496, -1.537496, -1.537496, -1.537496, -1.537496, -1.537496, -1.537496, -1.537496, -1.537496, -1.537496, -2.095640, -2.095640, -2.095640, -2.095640, -2.095640, -2.095640, -2.095640, -2.095640, -2.095640, -2.095640, -2.095640, -2.095640, -2.095640, -2.095640, -2.654552, -2.654552, -2.654552, -2.654552, -2.654552, -2.654552, -2.654552, -2.654552, -2.654552, -2.654552, -2.654552, -2.654552, -2.654552, -2.654552, -2.654552, -3.164799, -3.164799, -3.164799, -3.164799, -3.164799, -3.164799, -3.164799, -3.164799, -3.164799, -3.164799, -3.164799, -3.164799, -3.164799, -3.164799, -3.594855, -3.594855, -3.594855, -3.594855, -3.594855, -3.594855, -3.594855, -3.594855, -3.594855, -3.594855, -3.594855, -3.594855, -3.594855, -3.594855, -3.948750, -3.948750, -3.948750, -3.948750, -3.948750, -3.948750, -3.948750, -3.948750, -3.948750, -3.948750, -3.948750, -3.948750, -3.948750, -3.948750, -4.247421, -4.247421, -4.247421, -4.247421, -4.247421, -4.247421, -4.247421, -4.247421, -4.247421, -4.247421, -4.247421, -4.247421, -4.247421, -4.247421, -4.247421, -4.514071, -4.514071, -4.514071, -4.514071, -4.514071, -4.514071, -4.514071, -4.514071, -4.514071, -4.514071, -4.514071, -4.514071, -4.514071, -4.514071, -4.765918, -4.765918, -4.765918, -4.765918, -4.765918, -4.765918, -4.765918, -4.765918, -4.765918, -4.765918, -4.765918, -4.765918, -4.765918, -4.765918, -5.008715, -5.008715, -5.008715, -5.008715, -5.008715, -5.008715, -5.008715, -5.008715, -5.008715};
// float zero_electric_angle = 1.994816;
// Direction sensor_direction = Direction::CW;

// float calibrationLut[100] = {
// -2.967450, -2.967450, -2.967450, -3.222366, -3.222366, -3.494614, -3.494614, -3.494614, -3.797313, -3.797313, -3.797313, -4.161179, -4.161179, -4.161179, -4.609375, -4.609375, -4.609375, -5.128403, -5.128403, -5.128403, -4.155819, -4.155819, -4.155819, -2.688325, -2.688325, 0.782625, 0.782625, 0.782625, 2.864807, 2.864807, 2.864807, 5.022844, 5.022844, 5.022844, 4.724134, 4.724134, 4.724134, 4.457254, 4.457254, 4.457254, 4.205101, 4.205101, 4.205101, 3.962151, 3.962151, 3.722384, 3.722384, 3.722384, 3.479818, 3.479818, 3.479818, 3.233724, 3.233724, 3.233724, 2.973402, 2.973402, 2.973402, 2.684586, 2.684586, 2.684586, 2.353547, 2.353547, 2.353547, 1.942512, 1.942512, 1.433455, 1.433455, 1.433455, 0.868139, 0.868139, 0.868139, 0.289439, 0.289439, 0.289439, 
// -0.267709, -0.267709, -0.267709, -0.750420, -0.750420, -0.750420, -1.136835, -1.136835, -1.136835, -1.455717, -1.455717, -1.733987, -1.733987, -1.733987, -1.990129, -1.990129, -1.990129, -2.237642, -2.237642, -2.237642, -2.480439, -2.480439, -2.480439, -2.722199, -2.722199, -2.722199};
// float zero_electric_angle = 2.260836;
// Direction sensor_direction = Direction::CW;

// float calibrationLut[35] = {
// -5.249016, -3.987092, -2.233220, 1.538221, 3.760916, 5.942500, 5.532806, 5.025667, 4.461693, 3.884872, 3.328339, 2.845474, 2.458024, 2.138644, 1.859914, 
// 1.603619, 1.355798, 1.113002, 0.871356, 0.626181, 0.371113, 0.098518, -0.204793, -0.569618, -1.019502, -1.540485, -2.099051, -2.657886, -3.168170, -3.597575, -3.950626, -4.248609, -4.514952, -4.766684, -5.009364};
// float zero_electric_angle = 1.996772;
// Direction sensor_direction = Direction::CW;

float calibrationLut[350] = {
2.553380, 2.503041, 2.452020, 2.400056, 2.347167, 2.293577, 2.239591, 2.185395, 2.130988, 2.076285, 2.021432, 1.966442, 1.911349, 1.856017, 1.800409, 1.744449, 1.688005, 1.631282, 1.574447, 1.517559, 1.460632, 1.403720, 1.346901, 1.290242, 1.233937, 1.177969, 1.122196, 1.066665, 1.011406, 0.956436, 0.901733, 0.847307, 0.793156, 0.739462, 0.686424, 0.634172, 0.582997, 0.533299, 0.484655, 0.436925, 0.390145, 0.344413, 0.299613, 0.255659, 0.212496, 0.170222, 0.128677, 0.087865, 0.047789, 0.008469, -0.030031, -0.067860, -0.105029, -0.141240, -0.176483, -0.210884, -0.244617, -0.277749, -0.310408, -0.342645, -0.374610, -0.406300, -0.437663, -0.468484, -0.498709, -0.528273, -0.557205, -0.585646, -0.613822, -0.641726, -0.669331, -0.696575, -0.723444, -0.749986, -0.776310, -0.802573, -0.828720, -0.854806, -0.880763, -0.906592, -0.932279, -0.957790, -0.983106, -1.008267, -1.033322, -1.058308, -1.083228, -1.108076, 
-1.132876, -1.157628, -1.182353, -1.207070, -1.231711, -1.256263, -1.280727, -1.305061, -1.329188, -1.353199, -1.377138, -1.400996, -1.424800, -1.448539, -1.472255, -1.496002, -1.519868, -1.543788, -1.567772, -1.591795, -1.615818, -1.639879, -1.663956, -1.688040, -1.712090, -1.736163, -1.760243, -1.784350, -1.808491, -1.832717, -1.856993, -1.881350, -1.905806, -1.930377, -1.955017, -1.979684, -2.004363, -2.028991, -2.053650, -2.078344, -2.103080, -2.127884, -2.152786, -2.177889, -2.203400, -2.229240, -2.255256, -2.281430, -2.307823, -2.334437, -2.361324, -2.388487, -2.415899, -2.443522, -2.471337, -2.499309, -2.527477, -2.555905, -2.584713, -2.613935, -2.643693, -2.674086, -2.704988, -2.736250, -2.767828, -2.799773, -2.832029, -2.864748, -2.897959, -2.931706, -2.966082, -3.001375, -3.037423, -3.074684, -3.113592, -3.153678, -3.194857, -3.237049, -3.280314, -3.324523, -3.369472, -3.415414, -3.462442, -3.510462, -3.559243, -3.608881, -3.659357, -3.710760, -3.762976, -3.815852, -3.869548, -3.924223, -3.979584, -4.035389, -4.091386, -4.147629, -4.204110, -4.260756, -4.317585, -4.374591, -4.431766, -4.489252, -4.547036, -4.605231, -4.663690, -4.722249, -4.780824, -4.839422, -4.897953, -4.956375, -5.014555, -5.072393, -5.129881, -5.187118, -5.244116, -5.300812, -5.357189, -5.413209, -5.468880, -5.524142, -5.578866, -5.632666, -5.558943, -5.479140, -5.392817, -5.300438, -5.202093, -5.097843, -4.987577, -4.871422, -4.749602, -4.621820, -4.487949, -4.348058, -4.202390, -4.050858, -3.893466, -3.730134, -3.560984, -3.386192, -3.205564, -3.018883, -2.826386, -2.628223, -2.424467, -2.215159, -2.000491, -0.381297, -0.162117, 0.057415, 0.277338, 0.497718, 0.718704, 0.940276, 1.162527, 1.385261, 1.608256, 1.831439, 2.054894, 2.278637, 2.502656, 2.726897, 2.951318, 3.175897, 3.400583, 3.625338, 3.850205, 4.075151, 4.300220, 4.525494, 4.750996, 4.976676, 5.202462, 5.177072, 5.151681, 5.126352, 5.101054, 5.075764, 5.050504, 5.025328, 5.000218, 4.975177, 4.950193, 4.925309, 
4.900620, 4.876078, 4.851608, 4.827230, 4.802875, 4.778551, 4.754189, 4.729718, 4.705179, 4.680594, 4.655944, 4.631275, 4.606598, 4.582399, 4.558181, 4.533985, 4.509790, 4.485572, 4.461322, 4.437039, 4.412686, 4.388261, 4.363774, 4.339165, 4.314456, 4.289681, 4.264880, 4.240097, 4.215350, 4.190606, 4.165847, 4.141034, 4.116195, 4.091240, 4.066074, 4.040479, 4.014542, 3.988433, 3.962147, 3.935689, 3.908974, 3.881975, 3.854689, 3.827142, 3.799464, 3.771610, 3.743618, 3.715407, 3.686959, 3.658157, 3.628877, 3.599078, 3.568651, 3.537725, 3.506496, 3.474991, 3.443137, 3.410973, 3.378424, 3.345439, 3.312044, 3.278103, 3.243484, 3.208076, 3.171577, 3.133534, 3.094397, 3.054302, 3.013225, 2.971090, 2.927999, 2.884039, 2.839265, 2.793601, 2.747101, 2.699824, 2.651798, 2.602997};
float zero_electric_angle = 2.878795;
Direction sensor_direction = Direction::CW;


// CalibratedSensor sensor_calibrated = CalibratedSensor(sensor, 500, calibrationLut);
CalibratedSensor sensor_calibrated = CalibratedSensor(sensor, 350);

//  BLDCDriver3PWM( pin_pwmA, pin_pwmB, pin_pwmC, enable (optional))
BLDCDriver3PWM driver = BLDCDriver3PWM(1, 2, 42, 41);

//  BLDCMotor( pole_pairs , ( phase_resistance, KV_rating  optional) )
BLDCMotor motor = BLDCMotor(7, 6.5/2, 330);




void setup()
{
  delay(2000);

  Serial.begin(115200);

  motor.useMonitoring(Serial);
  // SimpleFOCDebug::enable(&Serial);

  SPI.begin(48, 45, -1); 

  // pwm frequency to be used [Hz]
  driver.pwm_frequency = 40000;
  // power supply voltage [V]
  driver.voltage_power_supply = 9;
  // Max DC voltage allowed - default voltage_power_supply
  driver.voltage_limit = 9;
  // driver init

  // set control loop type to be used
  // motor.controller = MotionControlType::velocity_openloop;
  // motor.controller = MotionControlType::velocity;
  

  motor.zero_electric_angle = zero_electric_angle;
  motor.sensor_direction = sensor_direction;

  


  // // pole pairs calculation routine
  // Serial.println("Pole pairs (PP) estimator");
  // Serial.println("-\n");

  // float pp_search_voltage = 4; // maximum power_supply_voltage/2
  // float pp_search_angle = 6*_PI; // search electrical angle to turn

  // // move motor to the electrical angle 0
  // motor.controller = MotionControlType::angle_openloop;
  // motor.voltage_limit=pp_search_voltage;
  // motor.move(0);
  // _delay(1000);
  // // read the encoder angle
  // sensor.update(); 
  // float angle_begin = sensor.getAngle();
  // _delay(50);

  // // move the motor slowly to the electrical angle pp_search_angle
  // float motor_angle = 0;
  // while(motor_angle <= pp_search_angle){
  //   motor_angle += 0.01f;
  //   motor.move(motor_angle);
  //   _delay(1);
  // }
  // _delay(1000);
  // // read the encoder value for 180
  // sensor.update(); 
  // float angle_end = sensor.getAngle();
  // _delay(50);
  // // turn off the motor
  // motor.move(0);
  // _delay(1000);

  // // calculate the pole pair number
  // int pp = round((pp_search_angle)/(angle_end-angle_begin));

  // Serial.print(F("Estimated PP : "));
  // Serial.println(pp);
  // Serial.println(F("PP = Electrical angle / Encoder angle "));
  // Serial.print(pp_search_angle*180/_PI);
  // Serial.print("/");
  // Serial.print((angle_end-angle_begin)*180/_PI);
  // Serial.print(" = ");
  // Serial.println((pp_search_angle)/(angle_end-angle_begin));
  // Serial.println();


  // // a bit of monitoring the result
  // if(pp <= 0 ){
  //   Serial.println(F("PP number cannot be negative"));
  //   Serial.println(F(" - Try changing the search_voltage value or motor/encoder configuration."));
  //   return;
  // }else if(pp > 30){
  //   Serial.println(F("PP number very high, possible error."));
  // }else{
  //   Serial.println(F("If PP is estimated well your motor should turn now!"));
  //   Serial.println(F(" - If it is not moving try to relaunch the program!"));
  //   Serial.println(F(" - You can also try to adjust the target voltage using serial terminal!"));
  // }



      // set control loop type to be used
    motor.controller = MotionControlType::velocity;

    // velocity PID controller parameters
    // default P=0.5 I = 10 D =0
    motor.PID_velocity.P = 0.02;
    motor.PID_velocity.I = 2;
    motor.PID_velocity.D = 0.00;
    // jerk control using voltage voltage ramp
    // default value is 300 volts per sec  ~ 0.3V per millisecond
    motor.PID_velocity.output_ramp = 0;

    // velocity low pass filtering
    // default 5ms - try different values to see what is the best. m,
    // the lower the less filtered
    motor.LPF_velocity.Tf = 1 / (6.28 * 200);

    // setting the limits
    // either voltage
    // motor.voltage_limit = 10; // Volts - default driver.voltage_limit
    // // of current
    // motor.current_limit = 2; // Amps - default 0.2Amps

    // angle PID controller
    // default P=20
    motor.P_angle.P = 20;
    motor.P_angle.I = 0; // usually only P controller is enough
    motor.P_angle.D = 0; // usually only P controller is enough
    // acceleration control using output ramp
    // this variable is in rad/s^2 and sets the limit of acceleration
    motor.P_angle.output_ramp = 0; // default 1e6 rad/s^2

    // angle low pass filtering
    // default 0 - disabled
    // use only for very noisy position sensors - try to avoid and keep the values very small
    motor.LPF_angle.Tf = 0; // default 0

    // setting the limits
    //  maximal velocity of the position control
    motor.velocity_limit = 10000; // rad/s - default 20

    // motor.PID_velocity.limit = 1;
    // motor.P_angle.limit = 200;


  sensor.init();
  driver.init();
  motor.linkDriver(&driver);
  motor.linkSensor(&sensor_calibrated);
  motor.init();


  //   // set voltage to run calibration
  // sensor_calibrated.voltage_calibration = 9;
  // // Running calibration
  sensor_calibrated.calibrate(motor, 200); 



  if (motor.initFOC())
    Serial.println("FOC init success!");
  else
  {
    Serial.println("FOC init failed!");
    return;
  }
}

void loop()
{
  // motor.disable();
  //   sensor.update();
  //   float angle = sensor.getAngle();
  //   Serial.println(angle);

    motor.loopFOC();

    motor.move(1);
}
